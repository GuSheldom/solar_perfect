# 带POA约束的线性规划优化模型 - 详细逻辑说明

## 📋 模型概述

这是一个**线性规划（LP）优化模型**，用于最大化光伏+储能电站的收益，同时遵循**POA（辐照度）相关的操作约束**。

---

## 🎯 核心目标

**最大化净收益 = 上网收益 - 购电成本**

```python
目标函数 = Σ(上网收益) - Σ(购电成本)
         = Σ[(光伏上网 + 储能上网) × RRP / 1000] - Σ[从电网购电 × RRP / 1000]
```

---

## 📊 关键参数

### 1. 电网限制
- **NEL** = 4440 kW（对电网最大输出功率）
- **NIL** = 670 kW（从电网最大输入功率）

### 2. 电池参数
- **容量** = 5504 kWh
- **最大充电功率** = 2752 kW
- **最大放电功率** = 2752 kW
- **充电效率** = 95%
- **放电效率** = 95%

### 3. 价格限制
- **LGC** = -10 AUD/MWh（最低发电价格）

### 4. POA阈值（核心约束）
- **POA_CHARGE_THRESHOLD** = 10 W/m²（只有POA > 10才能充电）
- **POA_DAYTIME_THRESHOLD** = 5 W/m²（POA > 5认为是白天）

---

## 🔢 决策变量（每个5分钟时段 t）

| 变量名 | 含义 | 约束 |
|--------|------|------|
| `charge_pv[t]` | 光伏用于充电的能量 | 0 ≤ x ≤ PV_Energy（且仅POA>10时>0）|
| `charge_grid[t]` | 从电网购电充电的能量 | 0 ≤ x ≤ NIL×时间（且仅POA>10时>0）|
| `discharge[t]` | 电池放电量 | 0 ≤ x ≤ 最大放电功率×时间 |
| `export_pv[t]` | 光伏直接上网的能量 | 0 ≤ x ≤ PV_Energy |
| `export_battery[t]` | 储能上网的能量 | ≥ 0 |
| `curtail[t]` | 弃电量 | 0 ≤ x ≤ PV_Energy |
| `soc[t]` | 电池荷电状态（SOC） | 0 ≤ x ≤ 5504 kWh |

**总计：8,640个时段 × 7个变量 = 60,480个决策变量**

---

## 🔒 核心约束条件

### ⭐ **约束1：POA充电限制（最重要！）**

```python
如果 POA[t] ≤ 10 W/m²:
    charge_pv[t] = 0      # 不能用光伏充电
    charge_grid[t] = 0    # 不能从电网充电
```

**含义：**
- 只有在**白天**（POA > 10 W/m²）才允许充电
- 夜间（POA ≤ 10）**完全禁止充电**
- 这是与"无POA约束模型"的**最大区别**

**统计结果：**
- 可充电时段：3,489 / 8,640 (40.4%)
- 禁止充电时段：5,151 / 8,640 (59.6%)

---

### 约束2：光伏能量平衡

```python
charge_pv[t] + export_pv[t] + curtail[t] = PV_Energy[t]
```

**含义：**
每个时段的光伏发电必须全部分配到：
1. 用于电池充电
2. 直接上网发电
3. 弃电

---

### 约束3：电池SOC递推

```python
SOC[0] = (charge_pv[0] + charge_grid[0]) × 0.95 - discharge[0] / 0.95

SOC[t] = SOC[t-1] + (charge_pv[t] + charge_grid[t]) × 0.95 - discharge[t] / 0.95
```

**含义：**
- SOC随时间递推
- 充电考虑95%效率
- 放电也考虑95%效率
- SOC范围：0 ~ 5504 kWh

---

### 约束4：储能上网能量

```python
export_battery[t] = discharge[t] × 0.95
```

**含义：**
储能上网的能量 = 放电量 × 放电效率

---

### 约束5：充电功率限制

```python
(charge_pv[t] + charge_grid[t]) / 0.0833小时 ≤ 2752 kW
```

**含义：**
总充电功率不能超过电池最大充电功率

---

### 约束6：NEL限制（电网输出）

```python
(export_pv[t] + export_battery[t]) / 0.0833小时 ≤ 4440 kW
```

**含义：**
总上网功率不能超过电网接入限制

---

### 约束7：LGC限制（最低发电价格）

```python
如果 RRP[t] ≤ -10 AUD/MWh:
    export_pv[t] = 0       # 光伏不上网
    export_battery[t] = 0  # 储能不上网
```

**含义：**
当电价低于-10时，禁止上网（避免亏损），只能弃电

**统计结果：**
- 受LGC限制时段：1,780 / 8,640 (20.6%)

---

## 🔄 模型运行流程

### 第1步：数据准备
```
加载Excel数据 → 提取POA、PV发电量、电价RRP
                ↓
计算Can_Charge标记（POA > 10的时段）
```

### 第2步：构建LP模型
```
创建60,480个决策变量
    ↓
定义目标函数：最大化(上网收益 - 购电成本)
    ↓
添加7大类约束条件（包括POA充电限制）
```

### 第3步：求解优化
```
调用CBC求解器
    ↓
在满足所有约束的前提下，寻找最大化收益的解
    ↓
求解时间：~0.9秒（非常快！）
```

### 第4步：提取结果
```
获取每个时段的：
- 充电量（光伏+电网）
- 放电量
- 上网量（光伏+储能）
- SOC
- 收益
```

---

## 📈 实际运行结果（31天）

### 收益表现
- **累计净收益**：$131,954
- **平均日收益**：$4,257
- **年化估算**：$1,553,647

### 能量流动
| 项目 | 数值 | 占比 |
|------|------|------|
| 光伏总发电 | 368,549 kWh | 100% |
| 用于充电 | 144,717 kWh | 39.3% |
| 直接上网 | 125,747 kWh | 34.1% |
| 弃电 | 98,085 kWh | 26.6% |
| 从电网购电 | 113,561 kWh | - |
| 总充电量 | 258,278 kWh | - |
| 总放电量 | 233,096 kWh | - |

### POA约束验证 ✓
- **POA > 10时充电**：258,278 kWh (100%)
- **POA ≤ 10时充电**：0 kWh (0%) ✓ **严格遵守**

### 电池充满情况
- **充满天数**：29 / 31 天 (93.5%)
- **未充满天数**：
  - 7月25日：最高SOC = 34.8%
  - 7月31日：最高SOC = 8.8%

---

## 🆚 与无POA约束模型的对比

| 对比项 | 无POA约束 | 带POA约束 | 差异 |
|--------|-----------|-----------|------|
| **净收益（31天）** | $153,224 | $131,954 | **-$21,270 (-13.9%)** |
| 总充电量 | 414,630 kWh | 258,278 kWh | -156,352 kWh |
| POA>10时充电 | 247,930 kWh | 258,278 kWh | +10,348 kWh |
| POA≤10时充电 | **166,700 kWh** | **0 kWh** | -166,700 kWh |
| 从电网购电 | 279,017 kWh | 113,561 kWh | -165,456 kWh |

**关键发现：**
无POA约束模型在**夜间充电166,700 kWh**（占总充电40.2%），这部分夜间充电带来了**额外$21,270收益**。

---

## 💡 模型逻辑的本质

### 这个模型做了什么？

1. ✅ **严格遵守POA约束**：只在POA>10时充电
2. ✅ **自动选择最优时段**：
   - 在所有POA>10的时段中，LP求解器会自动选择RRP最低的时段充电
   - 在高RRP时段放电上网
3. ✅ **平衡多重约束**：
   - 同时满足：电网限制、电池限制、效率损耗、LGC限制等
4. ✅ **全局最优**：
   - 不是贪心算法，而是找到在所有约束下的全局最优解

### 这个模型没有做什么？

1. ❌ **没有强制每日充满**：
   - 因为这会导致问题无可行解
   - 但实际结果显示93.5%的天数自然达到了充满
2. ❌ **没有固定充放电次数**：
   - 允许一天内多次充放电（如果有利可图）
3. ❌ **没有预设优先级**：
   - 完全由LP求解器根据收益最大化目标决定

---

## 🎯 总结

**带POA约束的模型 = 线性规划（全局最优）+ POA充电限制（只在白天充电）**

**优点：**
- ✅ 严格遵循"白天充电"的操作逻辑
- ✅ 在满足POA约束的前提下达到最优收益
- ✅ 数学上保证最优解
- ✅ 求解速度快（<1秒）

**代价：**
- ⚠️ 损失13.9%的收益（$21,270/月）
- ⚠️ 因为放弃了夜间低价充电的套利机会

**适用场景：**
- 如果运营规则要求只能在白天充电
- 如果夜间电网不稳定或有其他限制
- 如果遵循特定的操作协议

---

## 📁 相关文件

- **模型代码**：`optimization_with_poa_constraints.py`
- **结果文件**：`optimization_results_poa_constraints/`
  - `detailed_results.csv` - 8,640行详细数据
  - `daily_summary.csv` - 31天每日汇总
  - `optimization_results_POA约束.xlsx` - Excel格式结果
- **对比分析**：`model_comparison_summary.xlsx`

---

*生成时间：2025年11月*

