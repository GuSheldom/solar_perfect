# 当前项目的线性规划数学公式

## 📋 问题概述

**储能电站收益最大化优化问题（带POA约束）**

---

## 🎯 目标函数

### 最大化净收益

```
最大化：Z = Σ(t=0 to 8639) [Revenue(t) - Cost(t)]

其中：
Revenue(t) = (ExportPV(t) + ExportBattery(t)) × RRP(t) / 1000
Cost(t) = ChargeGrid(t) × RRP(t) / 1000
```

**展开后：**

```
max Z = Σ(t=0 to 8639) [(ep(t) + eb(t)) × rrp(t)/1000 - cg(t) × rrp(t)/1000]
```

**含义：**
- 上网收益 - 购电成本
- RRP单位：$/MWh，能量单位：kWh，所以除以1000
- t = 0, 1, 2, ..., 8639（共8,640个5分钟时段）

---

## 📊 决策变量（共60,480个）

对于每个时段 t ∈ {0, 1, 2, ..., 8639}，有7个决策变量：

| 变量符号 | 完整名称 | 含义 | 单位 | 数量 |
|---------|---------|------|------|------|
| cp(t) | charge_pv[t] | 光伏用于充电的能量 | kWh | 8,640 |
| cg(t) | charge_grid[t] | 从电网购电充电的能量 | kWh | 8,640 |
| d(t) | discharge[t] | 电池放电量 | kWh | 8,640 |
| ep(t) | export_pv[t] | 光伏直接上网的能量 | kWh | 8,640 |
| eb(t) | export_battery[t] | 储能上网的能量 | kWh | 8,640 |
| cur(t) | curtail[t] | 弃电量 | kWh | 8,640 |
| soc(t) | soc[t] | 电池荷电状态（SOC） | kWh | 8,640 |
| **总计** | | | | **60,480** |

---

## 🔒 约束条件（共57,062个）

### 约束1：光伏能量平衡（8,640个约束）

```
∀t ∈ {0, 1, ..., 8639}:
    cp(t) + ep(t) + cur(t) = PV(t)
```

**含义：** 每个时段的光伏发电必须全部分配

**示例：** t=0时刻
```
cp(0) + ep(0) + cur(0) = 178.76 kWh
```

---

### ⭐ 约束2：POA充电限制（5,151个约束）

```
∀t ∈ T_night = {t | POA(t) ≤ 10}:
    cp(t) = 0
    cg(t) = 0
```

**含义：** 夜间（POA ≤ 10 W/m²）禁止充电

**实际统计：**
- T_night包含5,151个时段（59.6%）
- 产生10,302个约束（5,151 × 2）

**示例：** t=100时刻，POA=5 W/m²
```
cp(100) = 0
cg(100) = 0
```

---

### 约束3：电池SOC递推（8,640个约束）

**初始时刻（t=0）：**
```
soc(0) = [cp(0) + cg(0)] × η_c - d(0) / η_d
```

**后续时刻（t ≥ 1）：**
```
∀t ∈ {1, 2, ..., 8639}:
    soc(t) = soc(t-1) + [cp(t) + cg(t)] × η_c - d(t) / η_d
```

**其中：**
- η_c = 0.95（充电效率）
- η_d = 0.95（放电效率）

**含义：** SOC随时间递推，考虑充放电效率损耗

**示例：** t=1时刻
```
soc(1) = soc(0) + [cp(1) + cg(1)] × 0.95 - d(1) / 0.95
```

---

### 约束4：储能上网能量关系（8,640个约束）

```
∀t ∈ {0, 1, ..., 8639}:
    eb(t) = d(t) × η_d
```

**含义：** 储能上网能量 = 放电量 × 放电效率

**示例：** t=2时刻
```
eb(2) = d(2) × 0.95
```

---

### 约束5：充电功率限制（8,640个约束）

```
∀t ∈ {0, 1, ..., 8639}:
    [cp(t) + cg(t)] / Δt ≤ P_charge_max
```

**其中：**
- Δt = 5/60 = 0.0833小时（5分钟）
- P_charge_max = 2752 kW

**等价形式：**
```
cp(t) + cg(t) ≤ 2752 × 0.0833 = 229.33 kWh
```

**含义：** 总充电功率不能超过电池最大充电功率

---

### 约束6：放电功率限制（8,640个约束）

```
∀t ∈ {0, 1, ..., 8639}:
    d(t) / Δt ≤ P_discharge_max
```

**等价形式：**
```
d(t) ≤ 2752 × 0.0833 = 229.33 kWh
```

**含义：** 放电功率不能超过电池最大放电功率

---

### 约束7：电网输出限制NEL（8,640个约束）

```
∀t ∈ {0, 1, ..., 8639}:
    [ep(t) + eb(t)] / Δt ≤ NEL
```

**其中：**
- NEL = 4440 kW

**等价形式：**
```
ep(t) + eb(t) ≤ 4440 × 0.0833 = 370 kWh
```

**含义：** 总上网功率不能超过电网接入限制

---

### 约束8：电网输入限制NIL（隐含在变量界）

```
∀t ∈ T_day = {t | POA(t) > 10}:
    cg(t) ≤ NIL × Δt = 670 × 0.0833 = 55.83 kWh
```

**含义：** 从电网购电功率不能超过NIL

---

### 约束9：LGC限制（3,560个约束）

```
∀t ∈ T_lgc = {t | RRP(t) ≤ -10}:
    ep(t) = 0
    eb(t) = 0
```

**含义：** 电价低于-10 AUD/MWh时禁止上网

**实际统计：**
- T_lgc包含1,780个时段（20.6%）
- 产生3,560个约束（1,780 × 2）

---

### 约束10：变量非负性

```
∀t ∈ {0, 1, ..., 8639}:
    cp(t) ≥ 0
    cg(t) ≥ 0
    d(t) ≥ 0
    ep(t) ≥ 0
    eb(t) ≥ 0
    cur(t) ≥ 0
```

---

### 约束11：变量上界

```
∀t ∈ {0, 1, ..., 8639}:
    cp(t) ≤ PV(t)        # 光伏充电不能超过光伏发电量
    ep(t) ≤ PV(t)        # 光伏上网不能超过光伏发电量
    cur(t) ≤ PV(t)       # 弃电不能超过光伏发电量
    0 ≤ soc(t) ≤ 5504    # SOC范围
```

---

## 📐 完整数学模型

### 标准形式

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    目标函数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

max Z = Σ(t=0 to 8639) [(ep(t) + eb(t)) × rrp(t)/1000 
                         - cg(t) × rrp(t)/1000]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                   约束条件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

s.t. (subject to)

[1] 光伏能量平衡（8,640个）：
    cp(t) + ep(t) + cur(t) = PV(t),  ∀t

[2] POA充电限制（10,302个）：
    cp(t) = 0,  ∀t ∈ {t | POA(t) ≤ 10}
    cg(t) = 0,  ∀t ∈ {t | POA(t) ≤ 10}

[3] SOC递推（8,640个）：
    soc(0) = [cp(0) + cg(0)] × 0.95 - d(0) / 0.95
    soc(t) = soc(t-1) + [cp(t) + cg(t)] × 0.95 - d(t) / 0.95,  ∀t ≥ 1

[4] 储能上网（8,640个）：
    eb(t) = d(t) × 0.95,  ∀t

[5] 充电功率（8,640个）：
    cp(t) + cg(t) ≤ 229.33,  ∀t

[6] 放电功率（隐含在变量界）：
    d(t) ≤ 229.33,  ∀t

[7] NEL限制（8,640个）：
    ep(t) + eb(t) ≤ 370,  ∀t

[8] LGC限制（3,560个）：
    ep(t) = 0,  ∀t ∈ {t | RRP(t) ≤ -10}
    eb(t) = 0,  ∀t ∈ {t | RRP(t) ≤ -10}

[9] 变量界：
    0 ≤ cp(t) ≤ PV(t),  ∀t
    0 ≤ cg(t) ≤ 55.83 (if POA(t) > 10),  ∀t
    0 ≤ d(t) ≤ 229.33,  ∀t
    0 ≤ ep(t) ≤ PV(t),  ∀t
    0 ≤ eb(t),  ∀t
    0 ≤ cur(t) ≤ PV(t),  ∀t
    0 ≤ soc(t) ≤ 5504,  ∀t

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📊 问题规模统计

| 项目 | 数量 | 说明 |
|------|------|------|
| **决策变量** | 60,480 | 8,640时段 × 7个变量 |
| **约束条件** | 57,062 | 详见下方分解 |
| **非零元素** | 134,821 | 矩阵中的非零系数 |
| **求解时间** | 0.9秒 | CBC求解器 |

### 约束条件分解

| 约束类型 | 数量 | 说明 |
|---------|------|------|
| 光伏能量平衡 | 8,640 | 每时段1个 |
| POA充电限制 | 10,302 | 5,151时段 × 2 |
| SOC递推 | 8,640 | 每时段1个 |
| 储能上网 | 8,640 | 每时段1个 |
| 充电功率限制 | 8,640 | 每时段1个 |
| NEL限制 | 8,640 | 每时段1个 |
| LGC限制 | 3,560 | 1,780时段 × 2 |
| **总计** | **57,062** | |

---

## 🔢 具体数值示例（7月1日 09:00-09:15）

### 时段0：09:00-09:05

**输入数据：**
- POA(0) = 565.4 W/m² > 10 ✓ 可充电
- PV(0) = 178.76 kWh
- RRP(0) = 299.6 $/MWh > -10 ✓ 可上网

**优化结果：**
```
cp(0) = 0       （不用光伏充电）
cg(0) = 0       （不从电网购电）
d(0) = 0        （不放电）
ep(0) = 178.76  （全部光伏上网）
eb(0) = 0       （储能不上网）
cur(0) = 0      （不弃电）
soc(0) = 0      （电池空）

收益 = 178.76 × 299.6 / 1000 = $53.56
```

**验证约束：**
```
[1] 178.76 = 0 + 178.76 + 0  ✓
[2] POA > 10，无限制  ✓
[3] soc(0) = 0 + 0 - 0 = 0  ✓
[4] eb(0) = 0 × 0.95 = 0  ✓
[5] 0 + 0 ≤ 229.33  ✓
[7] 178.76 + 0 ≤ 370  ✓
[8] RRP > -10，无限制  ✓
```

---

### 时段1：09:05-09:10

**输入数据：**
- POA(1) = 588.0 W/m² > 10 ✓ 可充电
- PV(1) = 185.91 kWh
- RRP(1) = 230.0 $/MWh（较低电价，充电好时机）

**优化结果：**
```
cp(1) = 185.91     （光伏全部用于充电）
cg(1) = 27.33      （从电网购电）
d(1) = 0           （不放电）
ep(1) = 0          （光伏不上网）
eb(1) = 0          （储能不上网）
cur(1) = 0         （不弃电）
soc(1) = 202.58    （电池充到37%）

收益 = 0 - 27.33 × 230 / 1000 = -$6.29（成本）
```

**验证约束：**
```
[1] 185.91 = 185.91 + 0 + 0  ✓
[2] POA > 10，可充电  ✓
[3] soc(1) = 0 + (185.91 + 27.33) × 0.95 - 0 = 202.58  ✓
[4] eb(1) = 0 × 0.95 = 0  ✓
[5] 185.91 + 27.33 = 213.24 ≤ 229.33  ✓
[7] 0 + 0 ≤ 370  ✓
[8] NIL限制: 27.33 ≤ 55.83  ✓
```

---

### 时段2：09:10-09:15

**输入数据：**
- POA(2) = 592.0 W/m² > 10 ✓ 可充电
- PV(2) = 187.17 kWh
- RRP(2) = 300.0 $/MWh（高电价，放电好时机）

**优化结果：**
```
cp(2) = 0          （光伏不充电）
cg(2) = 0          （不从电网购电）
d(2) = 192.45      （放电）
ep(2) = 187.17     （光伏上网）
eb(2) = 182.83     （储能上网）
cur(2) = 0         （不弃电）
soc(2) = 0         （电池放空）

收益 = (187.17 + 182.83) × 300 / 1000 = $111.00
```

**验证约束：**
```
[1] 187.17 = 0 + 187.17 + 0  ✓
[3] soc(2) = 202.58 + 0 - 192.45 / 0.95 = 0  ✓
[4] eb(2) = 192.45 × 0.95 = 182.83  ✓
[5] 0 + 0 ≤ 229.33  ✓
[6] 192.45 ≤ 229.33  ✓
[7] 187.17 + 182.83 = 370 ≤ 370  ✓（达到NEL上限！）
```

---

## 🎯 CBC求解器看到的格式（MPS文件）

CBC实际读取的是**MPS格式**（Mathematical Programming System）：

```
NAME          Battery_Optimization_POA_Constraints
ROWS
 N  OBJ        
 E  PV_Bal_0
 E  PV_Bal_1
 E  POA_Charge_PV_5151
 E  POA_Charge_Grid_5151
 E  SOC_0
 E  SOC_1
 ...
COLUMNS
    cp_0      OBJ       0.0
    cp_0      PV_Bal_0  1.0
    cp_1      OBJ       0.0
    cp_1      PV_Bal_1  1.0
    cp_1      SOC_1     0.95
    ...
RHS
    RHS1      PV_Bal_0   178.76
    RHS1      PV_Bal_1   185.91
    ...
BOUNDS
 UP BND1      cp_0       178.76
 UP BND1      cp_1       185.91
 ...
ENDATA
```

---

## 🔍 预处理后的问题（CBC自动简化）

```
原始问题：
├─ 60,480 个变量
├─ 57,062 个约束
└─ 134,821 个非零元素

预处理后：
├─ 15,209 个变量（-75%）
├─ 5,448 个约束（-90%）
└─ 22,541 个非零元素（-83%）

预处理做了什么？
1. 消除固定变量（如POA≤10时的充电变量）
2. 合并冗余约束
3. 简化线性组合
4. 检测隐含界
```

---

## 📈 最终求解结果

```
状态：Optimal（找到全局最优解）
目标值：Z* = $131,953.55
迭代次数：4,810次
求解时间：0.9秒

最优解包含：
- 每个时段的充放电策略
- 每个时段的上网量
- 每个时段的SOC
- 31天总收益最大化
```

---

## 🎓 总结

### 这个LP问题的特点

1. **大规模**：60,480个变量，57,062个约束
2. **稀疏**：只有0.004%的系数非零
3. **时序结构**：SOC递推形成链式约束
4. **线性**：所有关系都是线性的
5. **快速求解**：预处理后不到1秒

### CBC如何高效求解

1. **预处理**：减少90%的约束
2. **稀疏矩阵技术**：只存储非零元素
3. **单纯形法**：在顶点间智能搜索
4. **优化实现**：C++高效代码

### 保证最优的原因

- ✅ 目标函数是线性的
- ✅ 所有约束都是线性的
- ✅ 可行域是凸集
- ✅ 单纯形法保证找到全局最优

---

*这就是CBC求解器在我们项目中实际求解的完整数学模型！*

