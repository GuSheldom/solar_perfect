# POA约束线性规划模型 - 完整约束条件说明

## 📋 模型概述

这是一个**混合整数线性规划（MILP）**模型，用于优化光伏+储能系统的充放电策略，目标是最大化31天的总收益。

**时间范围**：2025年7月1日-7月31日（31天）  
**时间分辨率**：5分钟/时段  
**总时段数**：8,640个时段  
**决策变量数**：60,480个  
**约束条件数**：57,062个

---

## 🎯 目标函数

### **最大化净收益**

```
max  Z = Σ(t=0 → 8639) [Revenue(t) - Cost(t)]
```

#### **展开形式**

```
max  Z = Σ(t=0 → 8639) [
    (export_pv[t] + export_battery[t]) × RRP[t] / 1000
    - charge_grid[t] × RRP[t] / 1000
]
```

**含义**：
- **上网收益** = (光伏上网 + 储能上网) × 电价
- **购电成本** = 从电网充电 × 电价
- **净收益** = 上网收益 - 购电成本

**单位说明**：
- RRP单位：AUD/MWh（澳元/兆瓦时）
- 能量单位：kWh（千瓦时）
- 除以1000：将MWh转换为kWh

---

## 📊 决策变量（共60,480个）

对于每个时段 **t ∈ {0, 1, 2, ..., 8639}**，定义7个决策变量：

| 变量名 | 符号 | 含义 | 单位 | 下界 | 上界 | 数量 |
|--------|------|------|------|------|------|------|
| **光伏充电量** | `charge_pv[t]` | 光伏用于充电的能量 | kWh | 0 | `PV_Energy[t]` | 8,640 |
| **电网充电量** | `charge_grid[t]` | 从电网购电充电的能量 | kWh | 0 | `NIL × 0.0833` | 8,640 |
| **电池放电量** | `discharge[t]` | 电池放电量（放电前） | kWh | 0 | `2752 × 0.0833` | 8,640 |
| **光伏上网量** | `export_pv[t]` | 光伏直接上网的能量 | kWh | 0 | `PV_Energy[t]` | 8,640 |
| **储能上网量** | `export_battery[t]` | 储能上网的能量 | kWh | 0 | ∞ | 8,640 |
| **弃电量** | `curtail[t]` | 光伏弃电量 | kWh | 0 | `PV_Energy[t]` | 8,640 |
| **电池SOC** | `soc[t]` | 电池荷电状态 | kWh | 0 | 5504 | 8,640 |

**总计**：8,640个时段 × 7个变量 = **60,480个决策变量**

---

## 🔒 约束条件（共57,062个）

### **约束1：光伏能量平衡**

**数量**：8,640个约束（每个时段1个）

```
∀t ∈ {0, 1, ..., 8639}:
    charge_pv[t] + export_pv[t] + curtail[t] = PV_Energy[t]
```

**含义**：光伏发电必须全部分配，要么充电、要么上网、要么弃电

**示例**（t=0）：
```
charge_pv[0] + export_pv[0] + curtail[0] = 178.76 kWh
```

---

### **约束2：POA充电限制** ⭐ **核心约束**

**数量**：10,302个约束（5,151个时段 × 2）

```
∀t ∈ T_night = {t | POA[t] ≤ 10}:
    charge_pv[t] = 0      # 禁止光伏充电
    charge_grid[t] = 0    # 禁止电网充电
```

**含义**：
- 只有在 **POA > 10 W/m²** 时才允许充电
- 夜间（POA ≤ 10）**完全禁止充电**
- 这是与"无POA约束模型"的**最大区别**

**统计数据**：
- 可充电时段：3,489 / 8,640 (40.4%)
- 禁止充电时段：5,151 / 8,640 (59.6%)
- 产生约束数：5,151 × 2 = **10,302个**

**示例**（夜间时段 t=100，POA=0）：
```
charge_pv[100] = 0
charge_grid[100] = 0
```

---

### **约束3：电池SOC递推关系**

**数量**：8,640个约束（每个时段1个）

#### **初始时段（t=0）**

```
soc[0] = (charge_pv[0] + charge_grid[0]) × η_charge 
         - discharge[0] / η_discharge
```

#### **后续时段（t≥1）**

```
∀t ∈ {1, 2, ..., 8639}:
    soc[t] = soc[t-1] 
             + (charge_pv[t] + charge_grid[t]) × η_charge
             - discharge[t] / η_discharge
```

**参数**：
- `η_charge` = 0.95（充电效率）
- `η_discharge` = 0.95（放电效率）

**含义**：
- SOC遵循能量守恒
- 充电使SOC增加（乘以充电效率）
- 放电使SOC减少（除以放电效率）
- SOC递推关系确保电池状态连续

**边界条件**：
```
∀t: 0 ≤ soc[t] ≤ 5504 kWh
```

---

### **约束4：储能上网能量**

**数量**：8,640个约束（每个时段1个）

```
∀t ∈ {0, 1, ..., 8639}:
    export_battery[t] = discharge[t] × η_discharge
```

**含义**：
- 储能上网能量 = 放电量 × 放电效率
- 考虑放电效率损耗（95%）

**示例**（t=100）：
```
如果 discharge[100] = 229.33 kWh
则 export_battery[100] = 229.33 × 0.95 = 217.86 kWh
```

---

### **约束5：充电功率限制**

**数量**：8,640个约束（每个时段1个）

```
∀t ∈ {0, 1, ..., 8639}:
    (charge_pv[t] + charge_grid[t]) / Δt ≤ P_charge_max
```

**参数**：
- `P_charge_max` = 2,752 kW（电池最大充电功率）
- `Δt` = 5/60 = 0.0833 小时

**展开形式**：
```
charge_pv[t] + charge_grid[t] ≤ 2752 × 0.0833 = 229.33 kWh
```

**含义**：
- 总充电功率不能超过电池最大充电功率
- 5分钟内最多充电 229.33 kWh

---

### **约束6：放电功率限制**（隐含在变量上界）

**数量**：已包含在决策变量定义中

```
∀t ∈ {0, 1, ..., 8639}:
    discharge[t] ≤ P_discharge_max × Δt
    discharge[t] ≤ 2752 × 0.0833 = 229.33 kWh
```

**参数**：
- `P_discharge_max` = 2,752 kW（电池最大放电功率）

**含义**：
- 放电功率不能超过电池最大放电功率
- 5分钟内最多放电 229.33 kWh

---

### **约束7：NEL限制（电网输出限制）**

**数量**：8,640个约束（每个时段1个）

```
∀t ∈ {0, 1, ..., 8639}:
    (export_pv[t] + export_battery[t]) / Δt ≤ NEL
```

**参数**：
- `NEL` = 4,440 kW（对电网最大输出功率）
- `Δt` = 0.0833 小时

**展开形式**：
```
export_pv[t] + export_battery[t] ≤ 4440 × 0.0833 = 370 kWh
```

**含义**：
- 总上网功率不能超过电网接入限制
- 光伏和储能上网之和 ≤ NEL

---

### **约束8：NIL限制（电网输入限制）**（隐含在变量上界）

**数量**：已包含在决策变量定义中

```
∀t ∈ {0, 1, ..., 8639}:
    charge_grid[t] ≤ NIL × Δt
    charge_grid[t] ≤ 670 × 0.0833 = 55.83 kWh
```

**参数**：
- `NIL` = 670 kW（从电网最大输入功率）

**含义**：
- 从电网充电功率不能超过电网接入限制
- 5分钟内最多从电网充电 55.83 kWh

---

### **约束9：LGC限制（最低发电价格）**

**数量**：3,560个约束（1,780个时段 × 2）

```
∀t ∈ T_low_price = {t | RRP[t] ≤ LGC}:
    export_pv[t] = 0         # 光伏不上网
    export_battery[t] = 0    # 储能不上网
```

**参数**：
- `LGC` = -10 AUD/MWh（最低发电价格）

**含义**：
- 当电价低于-10 AUD/MWh时，禁止上网
- 避免在负电价时亏损
- 此时只能弃电

**统计数据**：
- 受LGC限制时段：1,780 / 8,640 (20.6%)
- 产生约束数：1,780 × 2 = **3,560个**

---

### **约束10：SOC容量限制**（隐含在变量上界）

**数量**：已包含在决策变量定义中

```
∀t ∈ {0, 1, ..., 8639}:
    0 ≤ soc[t] ≤ E_capacity
```

**参数**：
- `E_capacity` = 5,504 kWh（电池储能总量）

**含义**：
- 电池SOC不能为负
- 电池SOC不能超过容量

---

## 📈 约束条件汇总表

| 序号 | 约束名称 | 约束数量 | 公式 |
|------|---------|---------|------|
| 1 | 光伏能量平衡 | 8,640 | `charge_pv + export_pv + curtail = PV_Energy` |
| 2 | POA充电限制 | 10,302 | `charge_pv = 0, charge_grid = 0` (夜间) |
| 3 | SOC递推关系 | 8,640 | `soc[t] = soc[t-1] + 充电 - 放电` |
| 4 | 储能上网能量 | 8,640 | `export_battery = discharge × 0.95` |
| 5 | 充电功率限制 | 8,640 | `total_charge ≤ 2752 kW` |
| 6 | NEL限制 | 8,640 | `total_export ≤ 4440 kW` |
| 7 | LGC限制 | 3,560 | `export = 0` (电价≤-10) |
| 8 | 变量上下界 | 8,000+ | `0 ≤ var ≤ upper_bound` |
| **总计** | | **57,062+** | |

---

## ⚙️ 系统参数汇总

### **电网参数**

| 参数 | 符号 | 数值 | 单位 | 说明 |
|------|------|------|------|------|
| 对电网最大输出功率 | NEL | 4,440 | kW | Network Export Limit |
| 从电网最大输入功率 | NIL | 670 | kW | Network Import Limit |
| 最低发电价格 | LGC | -10 | AUD/MWh | Large-scale Generation Certificate |

### **电池参数**

| 参数 | 符号 | 数值 | 单位 | 说明 |
|------|------|------|------|------|
| 电池储能总量 | E_capacity | 5,504 | kWh | Battery capacity |
| 最大充电功率 | P_charge_max | 2,752 | kW | Max charging power |
| 最大放电功率 | P_discharge_max | 2,752 | kW | Max discharging power |
| 充电效率 | η_charge | 0.95 | - | Charging efficiency |
| 放电效率 | η_discharge | 0.95 | - | Discharging efficiency |
| 往返效率 | η_round_trip | 0.9025 | - | 0.95 × 0.95 |

### **POA阈值**

| 参数 | 符号 | 数值 | 单位 | 说明 |
|------|------|------|------|------|
| POA充电阈值 | POA_charge | 10 | W/m² | 只有POA>10才能充电 |
| POA白天阈值 | POA_daytime | 5 | W/m² | POA>5认为是白天 |

### **时间参数**

| 参数 | 符号 | 数值 | 单位 | 说明 |
|------|------|------|------|------|
| 数据间隔 | Δt_minutes | 5 | 分钟 | 时间分辨率 |
| 数据间隔 | Δt | 0.0833 | 小时 | 5/60小时 |
| 总时段数 | T | 8,640 | 个 | 31天×24小时×12 |
| 覆盖天数 | Days | 31 | 天 | 2025年7月 |

---

## 🔬 约束条件详细说明

### **1. 能量守恒约束**

```
光伏能量平衡：
  输入：PV_Energy[t]
  输出：charge_pv[t] + export_pv[t] + curtail[t]
  
电池能量平衡：
  输入：charge_pv[t] + charge_grid[t]（考虑效率）
  输出：discharge[t]（考虑效率）
  状态：soc[t]
```

### **2. 功率约束**

```
充电功率约束：
  (charge_pv + charge_grid) / Δt ≤ 2752 kW
  
放电功率约束：
  discharge / Δt ≤ 2752 kW
  
上网功率约束：
  (export_pv + export_battery) / Δt ≤ 4440 kW
  
电网输入约束：
  charge_grid / Δt ≤ 670 kW
```

### **3. 状态约束**

```
SOC约束：
  0 ≤ soc[t] ≤ 5504 kWh
  
SOC连续性：
  soc[t] = f(soc[t-1], charge[t], discharge[t])
```

### **4. 运行约束**

```
POA约束（核心）：
  if POA[t] ≤ 10:
      charge_pv[t] = 0
      charge_grid[t] = 0
      
电价约束：
  if RRP[t] ≤ -10:
      export_pv[t] = 0
      export_battery[t] = 0
```

---

## 🎮 求解方法

### **求解器**：CBC (COIN-OR Branch and Cut)

### **算法**：
1. 单纯形法（Simplex Method）
2. 分支定界法（Branch and Bound）
3. 线性松弛（Linear Relaxation）

### **求解参数**：
- 时间限制：600秒（10分钟）
- 打印选项：全部
- 模式：最大化

### **求解过程**：

```
1. 预处理（Presolve）
   原始: 57,062行 × 60,480列
   简化: 5,448行 × 15,209列（减少90%）
   
2. 迭代求解
   使用单纯形法迭代
   4,810次迭代后收敛
   
3. 后处理（Postsolve）
   恢复原始变量
   验证约束条件
   
4. 输出最优解
   目标函数值: $131,953.55
   求解时间: 0.35秒
   状态: Optimal
```

---

## 📊 运行结果

### **求解状态**

| 指标 | 数值 |
|------|------|
| 求解状态 | Optimal（最优） |
| 求解时间 | 0.9秒 |
| 迭代次数 | 4,810次 |
| 目标函数值 | $131,953.55 |

### **收益统计**

| 指标 | 数值 |
|------|------|
| 累计净收益 | $131,953.55 |
| 上网收益 | $134,791.46 |
| 购电成本 | $2,837.91 |
| 平均日收益 | $4,256.57 |
| 年化估算 | $1,553,646.62/年 |

### **能量统计**

| 指标 | 数值 | 占比 |
|------|------|------|
| 光伏总发电 | 368,549 kWh | 100% |
| └─ 用于充电 | 144,717 kWh | 39.3% |
| └─ 直接上网 | 125,747 kWh | 34.1% |
| └─ 弃电 | 98,085 kWh | 26.6% |
| 从电网购电 | 113,561 kWh | - |
| 总充电量 | 258,278 kWh | - |
| 总放电量 | 233,096 kWh | - |
| 储能上网 | 221,441 kWh | - |
| 总上网量 | 347,188 kWh | - |

### **约束验证**

| 验证项 | 结果 | 状态 |
|--------|------|------|
| POA约束 | 夜间充电量=0 kWh | ✅ 符合 |
| SOC范围 | 0 ≤ SOC ≤ 5504 | ✅ 符合 |
| 充电功率 | ≤ 2752 kW | ✅ 符合 |
| 放电功率 | ≤ 2752 kW | ✅ 符合 |
| NEL限制 | ≤ 4440 kW | ✅ 符合 |
| NIL限制 | ≤ 670 kW | ✅ 符合 |
| LGC限制 | 低价时不上网 | ✅ 符合 |

---

## 🔧 使用方法

### **运行脚本**

```bash
python optimization_with_poa_constraints.py
```

### **输入文件**

```
excel_1117.csv
  - 包含：日期、POA、电价RRP、光伏发电量
  - 时间跨度：31天
  - 时间分辨率：5分钟
```

### **输出文件**

```
optimization_results_poa_constraints/
├── detailed_results.csv      # 8,640行详细数据
├── daily_summary.csv          # 31天每日汇总
└── optimization_results_POA.xlsx  # Excel完整报告（3个工作表）
```

---

## 📝 注意事项

### **1. POA约束的影响**

- 禁止夜间充电导致**从电网购电增加**
- 只能在白天充电限制了**充电时段选择**
- 需要更激进的**白天充电策略**

### **2. 模型假设**

- ✅ 完美预知未来电价（理想情况）
- ✅ 完美预知未来光伏发电量
- ✅ 不考虑电池老化
- ✅ 不考虑设备故障

### **3. 约束可能冲突**

在某些极端情况下，约束可能导致无可行解：
- POA过低 + 电价过高 → 无法充电但需要放电
- 解决方案：模型会自动平衡，牺牲部分收益

---

## 🔗 相关文档

- `formula_lp.md` - 数学公式详解
- `POA_logic.md` - POA逻辑说明
- `Excel_logic.md` - Excel数据逻辑
- `贪心放电策略说明.md` - 贪心策略对比

---

## 📞 技术支持

如有问题，请检查：
1. 输入数据格式是否正确
2. 求解器是否安装（PuLP + CBC）
3. Python依赖是否完整（pandas, numpy, pulp）

---

**文档版本**：v1.0  
**更新日期**：2024年  
**模型状态**：已验证，运行正常 ✅

