# 线性规划算法详解

## 📚 什么是线性规划（Linear Programming, LP）？

线性规划是一种**数学优化方法**，用于在一组**线性约束条件**下，求解**线性目标函数**的最大值或最小值。

### 标准形式

```
最大化（或最小化）：  c₁x₁ + c₂x₂ + ... + cₙxₙ

约束条件：
    a₁₁x₁ + a₁₂x₂ + ... + a₁ₙxₙ  ≤ b₁
    a₂₁x₁ + a₂₂x₂ + ... + a₂ₙxₙ  ≤ b₂
    ...
    aₘ₁x₁ + aₘ₂x₂ + ... + aₘₙxₙ  ≤ bₘ
    
    x₁, x₂, ..., xₙ ≥ 0
```

**关键特点：**
- ✅ 目标函数是**线性**的（变量的一次方）
- ✅ 所有约束条件都是**线性**的
- ✅ 变量通常有**非负约束**

---

## 🔧 我们使用的求解器：CBC (COIN-OR Branch and Cut)

### 求解器信息

```python
Welcome to the CBC MILP Solver 
Version: 2.10.3
Build Date: Dec 15 2019
```

**CBC求解器特点：**
- 开源免费（COIN-OR项目）
- 支持线性规划（LP）和混合整数规划（MILP）
- 工业级性能
- 被PuLP库调用

---

## 🎯 核心算法：单纯形法（Simplex Method）

### 算法原理

**基本思想：**
线性规划问题的最优解一定在**可行域的顶点**上。单纯形法就是在这些顶点之间智能地搜索，直到找到最优顶点。

### 可视化理解（2D例子）

假设有2个变量x₁和x₂：

```
最大化： 3x₁ + 2x₂

约束条件：
    x₁ + x₂ ≤ 4      (约束1)
    2x₁ + x₂ ≤ 5     (约束2)
    x₁, x₂ ≥ 0        (非负约束)
```

**图形表示：**
```
  x₂
   |
 5 |    /约束2
   |   /
 4 |  /_____ 约束1
   | /    /|
 3 |/____/ |
   |    /  |
 2 |   /   |
   |  /    |
 1 | /_____|
   |/      |
 0 +-------+---> x₁
   0 1 2 3 4 5

可行域顶点：
A = (0, 0)
B = (0, 4)
C = (1, 3)  ← 最优解！
D = (2.5, 0)
```

**单纯形法的步骤：**

1. **找到初始可行顶点**（通常是原点）
2. **检查相邻顶点**，看是否有更优的
3. **移动到更优的顶点**
4. **重复**步骤2-3，直到没有更优的顶点
5. **当前顶点就是最优解**

---

## 🚀 单纯形法的具体步骤

### 步骤1：将问题转换为标准形式

**原始问题：**
```
最大化： 3x₁ + 2x₂

约束条件：
    x₁ + x₂ ≤ 4
    2x₁ + x₂ ≤ 5
    x₁, x₂ ≥ 0
```

**引入松弛变量s₁, s₂：**
```
最大化： 3x₁ + 2x₂ + 0s₁ + 0s₂

约束条件：
    x₁ + x₂ + s₁ = 4
    2x₁ + x₂ + s₂ = 5
    x₁, x₂, s₁, s₂ ≥ 0
```

### 步骤2：构建单纯形表

| 基变量 | x₁ | x₂ | s₁ | s₂ | RHS |
|--------|----|----|----|----|-----|
| s₁     | 1  | 1  | 1  | 0  | 4   |
| s₂     | 2  | 1  | 0  | 1  | 5   |
| **Z**  | -3 | -2 | 0  | 0  | 0   |

### 步骤3：选择入基变量

找目标行中**最负的系数**：-3（对应x₁）
→ x₁将入基

### 步骤4：选择出基变量

计算比值（RHS / 对应系数）：
- 第1行：4/1 = 4
- 第2行：5/2 = 2.5 ← 最小，s₂出基

### 步骤5：主元消去（高斯消元）

通过行变换，使x₁列变为 [0, 1, 0]ᵀ

### 步骤6：重复直到最优

当目标行所有系数≥0时，达到最优解。

---

## 🔢 在我们模型中的应用

### 我们的问题规模

```python
问题规模：
- 变量数：60,480 个（8,640时段 × 7个变量）
- 约束数：57,062 个
- 非零元素：134,821 个

求解时间：~0.9秒
```

### CBC求解过程（实际输出）

```
Presolve 5448 (-51614) rows, 15209 (-45271) columns
```
**预处理阶段：**
- 消除冗余约束：57,062 → 5,448 行
- 消除冗余变量：60,480 → 15,209 列
- 减少了90%的问题规模！

```
0    Obj 89.174923    Primal inf 67239.904
183  Obj 195989.99   Primal inf 809623.68
...
4810 Obj 131953.55
```
**迭代求解：**
- 迭代0：目标值 = $89.17
- 迭代183：目标值 = $195,989.99
- ...
- 迭代4810：目标值 = $131,953.55 ← 最优解！

```
Optimal - objective value 131953.55
Optimal objective 131953.547 - 4810 iterations time 0.102
```
**最终结果：**
- 状态：Optimal（最优）
- 目标值：$131,953.55
- 迭代次数：4,810次
- 求解时间：0.102秒

---

## 🎨 另一种算法：内点法（Interior Point Method）

### 与单纯形法的区别

| 特性 | 单纯形法 | 内点法 |
|------|---------|--------|
| 路径 | 沿着可行域边界（顶点到顶点）| 穿过可行域内部 |
| 迭代次数 | 取决于顶点数 | 几乎不受变量数影响 |
| 大规模问题 | 可能较慢 | 通常更快 |
| 暖启动 | 支持 | 不支持 |

### 内点法的基本思想

```
初始点
   ↓
可行域内部
   ↓
沿着下降方向前进
   ↓
逐渐接近最优解
   ↓
收敛到最优点
```

---

## 🔍 为什么LP能保证全局最优？

### 关键性质：凸性

**线性规划的可行域是凸集：**
```
如果x和y都是可行解，
那么它们的任意线性组合 λx + (1-λ)y 也是可行解
（其中 0 ≤ λ ≤ 1）
```

**目标函数是凸函数（或凹函数）：**
```
线性函数既是凸的也是凹的
```

**结论：**
> 凸优化问题的**局部最优解就是全局最优解**！

这就是为什么LP能保证找到全局最优解，而其他非线性问题可能只能找到局部最优。

---

## 💻 PuLP库的工作流程

### 我们的代码做了什么

```python
# 1. 创建问题
prob = LpProblem("Battery_Optimization", LpMaximize)

# 2. 定义变量
charge_pv = [LpVariable(f"cp_{t}", lowBound=0, upBound=...) for t in T]

# 3. 添加目标函数
prob += lpSum(revenue_terms) - lpSum(cost_terms)

# 4. 添加约束
prob += charge_pv[t] + export_pv[t] + curtail[t] == PV_Energy[t]

# 5. 求解
prob.solve(PULP_CBC_CMD())

# 6. 提取结果
value(charge_pv[t])
```

### PuLP内部流程

```
Python代码
    ↓
PuLP建模层（将问题转换为标准格式）
    ↓
生成MPS文件（标准LP格式）
    ↓
调用CBC求解器
    ↓
CBC读取MPS文件
    ↓
预处理（消除冗余）
    ↓
单纯形法求解
    ↓
生成解文件
    ↓
PuLP读取解并返回Python
```

---

## 📊 算法复杂度分析

### 理论复杂度

**单纯形法：**
- 最坏情况：指数时间 O(2ⁿ)
- 实际表现：多项式时间（平均情况）
- 通常远快于最坏情况

**内点法：**
- 理论保证：多项式时间 O(n³L)
- n = 变量数，L = 输入位数

### 实际性能

我们的问题：
```
60,480个变量 + 57,062个约束
    ↓
预处理后：15,209个变量 + 5,448个约束
    ↓
4,810次迭代
    ↓
0.9秒求解完成
```

**为什么这么快？**
1. **稀疏性**：大部分矩阵元素为0
2. **预处理**：消除了90%的冗余
3. **优化的实现**：CBC高度优化的C++代码
4. **问题结构**：时序问题有特殊结构

---

## 🆚 LP vs 其他优化方法对比

| 方法 | 保证最优 | 求解速度 | 适用问题 |
|------|---------|---------|---------|
| **线性规划** | ✅ 是 | 🚀 快 | 线性目标+线性约束 |
| 整数规划 | ✅ 是 | 🐌 慢 | 需要整数变量 |
| 非线性规划 | ❌ 否 | 🏃 中等 | 非线性目标/约束 |
| 启发式算法 | ❌ 否 | 🚀 快 | 复杂问题近似解 |
| 动态规划 | ✅ 是 | 🏃 中等 | 分阶段决策问题 |

---

## 🎓 为什么我们选择LP？

### 我们的问题特点

1. **目标函数是线性的**
   ```
   收益 = Σ(上网量 × 电价) - Σ(购电量 × 电价)
   ```

2. **约束条件都是线性的**
   ```
   - 能量平衡：charge + export + curtail = PV_Energy
   - SOC递推：SOC[t] = SOC[t-1] + charge - discharge
   - 功率限制：power ≤ max_power
   ```

3. **变量是连续的**
   - 充电量、放电量可以是任意非负实数
   - 不需要整数约束

### LP的优势

1. ✅ **全局最优**：保证找到最优解
2. ✅ **求解快速**：即使60,000个变量也不到1秒
3. ✅ **稳定可靠**：成熟的算法和求解器
4. ✅ **可扩展**：容易添加新约束

---

## 📖 延伸阅读

### 经典教材
1. **《线性规划》** - George Dantzig（单纯形法发明者）
2. **《凸优化》** - Stephen Boyd
3. **《运筹学导论》** - Hillier & Lieberman

### 在线资源
- [COIN-OR CBC文档](https://github.com/coin-or/Cbc)
- [PuLP官方文档](https://coin-or.github.io/pulp/)
- [单纯形法可视化](https://www.google.com/search?q=simplex+method+visualization)

---

## 🎯 总结

### 核心要点

1. **线性规划**通过**单纯形法**或**内点法**求解
2. **单纯形法**在可行域的顶点之间智能搜索
3. **CBC求解器**使用高度优化的算法实现
4. **预处理**是提速的关键（消除90%冗余）
5. **凸性**保证了全局最优解

### 实际表现

```
我们的问题：60,480个变量，57,062个约束
预处理后：15,209个变量，5,448个约束
迭代次数：4,810次
求解时间：0.9秒
结果：全局最优解 $131,953.55
```

**结论：** 线性规划是求解能源优化问题的理想方法！

---

*生成时间：2025年11月*

